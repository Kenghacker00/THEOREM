(function(){"use strict";let a=!1,E=[],c=null,h=0,l=0,e={mass:1e3,friction:100,force:0,forceType:"constant",position:0,velocity:0,work:0,netForce:0},t={mass:1e3,friction:80,force:0,forceType:"constant",position:0,velocity:0,work:0,netForce:0},s=1e3;function m(o,n,i){switch(n){case"constant":return o;case"increasing":return o*(1+i*.1);case"decreasing":return o*Math.max(.3,1-i*.05);case"impulse":return Math.sin(i*2)>.5?o*1.5:o*.5;default:return o}}function O(o,n){const i=new Float64Array(o);i[0]=n,i[1]=e.position,i[2]=e.velocity,i[3]=e.acceleration??0,i[4]=e.netForce??0,i[5]=.5*e.mass*Math.pow(e.velocity,2),i[6]=e.work??0,i[7]=t.position,i[8]=t.velocity,i[9]=t.acceleration??0,i[10]=t.netForce??0,i[11]=.5*t.mass*Math.pow(t.velocity,2),i[12]=t.work??0}function V(){if(a)return;a=!0,h=performance.now();const o=16;let n=0;function i(){if(!a)return;const b=performance.now();let w=b-h;w>250&&(w=250),h=b,n+=w;const X=4;let S=0;for(;n>=o&&S<X;){const r=o/1e3,v=l,g=l+r,P=m(e.force??0,e.forceType,v)-e.friction,M=P/e.mass,_=m(e.force??0,e.forceType,g)-e.friction,F=_/e.mass;let T=Math.max(0,e.velocity+.5*(M+F)*r),p=.5*(e.velocity+T)*r;if(s!=null){const y=s-e.position;if(p>=y){p=Math.max(0,y);const x=.5*(M+F),A=Math.max(0,e.velocity*e.velocity+2*x*p);T=Math.sqrt(A)}}l=g,e.position+=p,e.velocity=T,e.acceleration=.5*(M+F),.5*e.mass*Math.pow(e.velocity,2);const j=.5*(P+_);e.work=(e.work??0)+j*p,e.netForce=j;const q=m(t.force??0,t.forceType,v)-t.friction,d=q/t.mass,B=m(t.force??0,t.forceType,g)-t.friction,k=B/t.mass;let D=Math.max(0,t.velocity+.5*(d+k)*r),u=.5*(t.velocity+D)*r;if(s!=null){const y=s-t.position;if(u>=y){u=Math.max(0,y);const x=.5*(d+k),A=Math.max(0,t.velocity*t.velocity+2*x*u);D=Math.sqrt(A)}}t.position+=u,t.velocity=D,t.acceleration=.5*(d+k),.5*t.mass*Math.pow(t.velocity,2);const L=.5*(q+B);t.work=(t.work??0)+L*u,t.netForce=L,n-=o,S+=1}let f=E.pop();if(f||(f=new ArrayBuffer(Float64Array.BYTES_PER_ELEMENT*13)),O(f,l),self.postMessage({type:"tick",buf:f},[f]),s!=null){const r=e.position>=s,v=t.position>=s;if(r&&v){a=!1,self.postMessage({type:"finished",winner:"tie",final:{v1:e,v2:t}});return}if(r){a=!1,self.postMessage({type:"finished",winner:1,final:{v1:e,v2:t}});return}if(v){a=!1,self.postMessage({type:"finished",winner:2,final:{v1:e,v2:t}});return}}setTimeout(i,0)}i()}function N(){a=!1}self.addEventListener("message",o=>{const n=o.data;if(!(!n||typeof n.type!="string")){if(n.type==="init"){c=n.config||{},c.vehicle1&&Object.assign(e,c.vehicle1),c.vehicle2&&Object.assign(t,c.vehicle2),typeof c.raceDistance=="number"&&(s=c.raceDistance),typeof c.raceTime=="number"&&c.raceTime;return}if(n.type==="start"){V();return}if(n.type==="pause"){N();return}if(n.type==="reset"){e.position=c?.vehicle1?.initialPosition??0,e.velocity=c?.vehicle1?.initialVelocity??0,e.work=0,e.netForce=0,t.position=c?.vehicle2?.initialPosition??0,t.velocity=c?.vehicle2?.initialVelocity??0,t.work=0,t.netForce=0,l=0;return}if(n.type==="returnBuffer"){n.buf&&E.push(n.buf);return}if(n.type==="setParams"){const i=n.params||{};i.vehicle1&&Object.assign(e,i.vehicle1),i.vehicle2&&Object.assign(t,i.vehicle2),typeof i.raceDistance=="number"&&(s=i.raceDistance),typeof i.raceTime=="number"&&i.raceTime;return}}}),self.postMessage({type:"ready"})})();
