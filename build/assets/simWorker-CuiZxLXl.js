(function(){"use strict";let l=!1,d=[],c=null,w=0,r=0,e={mass:1e3,friction:100,force:0,forceType:"constant",position:0,velocity:0,work:0,netForce:0},t={mass:1e3,friction:80,force:0,forceType:"constant",position:0,velocity:0,work:0,netForce:0},s=1e3;function u(n,o,i){switch(o){case"constant":return n;case"increasing":return n*(1+i*.1);case"decreasing":return n*Math.max(.3,1-i*.05);case"impulse":return Math.sin(i*2)>.5?n*1.5:n*.5;default:return n}}function L(n,o){const i=new Float64Array(n);i[0]=o,i[1]=e.position,i[2]=e.velocity,i[3]=e.acceleration??0,i[4]=e.netForce??0,i[5]=.5*e.mass*Math.pow(e.velocity,2),i[6]=e.work??0,i[7]=t.position,i[8]=t.velocity,i[9]=t.acceleration??0,i[10]=t.netForce??0,i[11]=.5*t.mass*Math.pow(t.velocity,2),i[12]=t.work??0}function O(){if(l)return;l=!0,w=performance.now();const n=16;let o=0;function i(){if(!l)return;const k=performance.now();let g=k-w;g>250&&(g=250),w=k,o+=g;const V=4;let x=0;for(;o>=n&&x<V;){const a=n/1e3;r+=a;const D=u(e.force??0,e.forceType,r)-e.friction,m=D/e.mass;Math.max(0,e.velocity+m*a);const A=u(e.force??0,e.forceType,r)-e.friction,F=A/e.mass,E=Math.max(0,e.velocity+.5*(m+F)*a);let v=.5*(e.velocity+E)*a;if(s!=null){const y=s-e.position;if(v>=y){v=Math.max(0,y);const T=.5*(m+F);Math.max(0,e.velocity*e.velocity+2*T*v)}}e.position+=v,e.velocity=E,e.acceleration=.5*(m+F),.5*e.mass*Math.pow(e.velocity,2);const b=.5*(D+A);e.work=(e.work??0)+b*v,e.netForce=b;const P=u(t.force??0,t.forceType,r)-t.friction,h=P/t.mass;Math.max(0,t.velocity+h*a);const _=u(t.force??0,t.forceType,r)-t.friction,M=_/t.mass;let j=Math.max(0,t.velocity+.5*(h+M)*a),p=.5*(t.velocity+j)*a;if(s!=null){const y=s-t.position;if(p>=y){p=Math.max(0,y);const T=.5*(h+M);Math.max(0,t.velocity*t.velocity+2*T*p)}}t.position+=p,t.velocity=j,t.acceleration=.5*(h+M),.5*t.mass*Math.pow(t.velocity,2);const B=.5*(P+_);t.work=(t.work??0)+B*p,t.netForce=B,o-=n,x+=1}let f=d.pop();if(f||(f=new ArrayBuffer(Float64Array.BYTES_PER_ELEMENT*13)),L(f,r),self.postMessage({type:"tick",buf:f},[f]),s!=null){if(e.position>=s){l=!1,self.postMessage({type:"finished",winner:1,final:{v1:e,v2:t}});return}if(t.position>=s){l=!1,self.postMessage({type:"finished",winner:2,final:{v1:e,v2:t}});return}}setTimeout(i,0)}i()}function S(){l=!1}self.addEventListener("message",n=>{const o=n.data;if(!(!o||typeof o.type!="string")){if(o.type==="init"){c=o.config||{},c.vehicle1&&Object.assign(e,c.vehicle1),c.vehicle2&&Object.assign(t,c.vehicle2),typeof c.raceDistance=="number"&&(s=c.raceDistance),typeof c.raceTime=="number"&&c.raceTime;return}if(o.type==="start"){O();return}if(o.type==="pause"){S();return}if(o.type==="reset"){e.position=c?.vehicle1?.initialPosition??0,e.velocity=c?.vehicle1?.initialVelocity??0,e.work=0,e.netForce=0,t.position=c?.vehicle2?.initialPosition??0,t.velocity=c?.vehicle2?.initialVelocity??0,t.work=0,t.netForce=0,r=0;return}if(o.type==="returnBuffer"){o.buf&&d.push(o.buf);return}if(o.type==="setParams"){const i=o.params||{};i.vehicle1&&Object.assign(e,i.vehicle1),i.vehicle2&&Object.assign(t,i.vehicle2),typeof i.raceDistance=="number"&&(s=i.raceDistance),typeof i.raceTime=="number"&&i.raceTime;return}}}),self.postMessage({type:"ready"})})();
